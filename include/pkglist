#!/usr/bin/env zsh

# Some backwards-compatibility foobar...
# XXX: Remove this as soon as everyone should have the new version
typeset -g -i newmode=0
[[ -n $PDIR ]] && newmode=1
(( newmode )) || cd $1 || exit 100
(( newmode )) && cd /${(j:/:)${(s:/:)0}[1,-4]}

(( newmode )) || rm -f .list

for i in *(/,@); {
	if [[ -d $i/.git ]] {
		if (( newmode )) {
			echo -n "$i git "
			echo ${$(git --git-dir=$i/.git log -n 1)[2]}
		} else {
			echo -n "$i git " >> .list
			echo ${$(git --git-dir=$i/.git log -n 1)[2]} >> .list
		}
	} else {
		echo "$i: Unsupported or no repository" >&2
	}
}

if (( newmode == 0 )) {
	echo "Running pkglist manually or via cron is no longer neccessary and therefore depracated" >&2
}
